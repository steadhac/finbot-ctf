# ==============================================================================
# CI/CD Pipeline - Test Execution & Google Sheets Integration
# ==============================================================================
# Purpose: Automatically run tests on code changes and update Google Sheets
#          with test results for tracking and reporting
#
# Triggers:
#   - On push to main or develop branches
#   - On pull requests to main or develop branches
#
# Jobs:
#   1. test: Run pytest and update Google Sheets with results
# ==============================================================================

name: CI/CD Pipeline

# Event triggers for this workflow
on:
  push:
    # Trigger on pushes to these branches
    branches: [ main, develop ]
  pull_request:
    # Trigger on pull requests to these branches
    branches: [ main, develop ]

# Define workflow jobs
jobs:
  test:
    # Run on Ubuntu latest
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Check out the repository code
    # This allows the workflow to access your project files
    - uses: actions/checkout@v3
    
    # Step 2: Set up Python environment
    # Installs Python 3.11 for running tests
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # Step 3: Install dependencies
    # Upgrade pip and install project dependencies including test tools
    - name: Install dependencies
      run: |
        # Upgrade pip to latest version
        python -m pip install --upgrade pip
        # Install project dependencies from requirements.txt
        pip install -r requirements.txt
        # Install test and coverage tools
        pip install pytest pytest-cov
        # Install Google Sheets API libraries for integration
        pip install google-auth-oauthlib google-auth-httplib2 google-api-python-client
    
    # Step 4: Run tests with coverage reporting
    # Executes pytest on all test files in the tests/ directory
    # Generates coverage reports in JSON format for analysis
    - name: Run tests
      run: |
        # Run pytest with verbose output and coverage tracking
        # -v: verbose mode (show each test result)
        # --cov: generate coverage report
        # --cov-report=json: output coverage as JSON (useful for programmatic access)
        pytest tests/ -v --cov=. --cov-report=json
    
    # Step 5: Update Google Sheets with test results
    # This step always runs (success or failure) to log results
    # Logs: timestamp, git branch, test status, and GitHub run ID
    - name: Update Google Sheets
      if: always()  # Run regardless of test pass/fail
      run: |
        # Execute Python script to update Google Sheets
        python - << 'PYTHON'
        
        # ==================================================================
        # Google Sheets Update Script
        # ==================================================================
        # This script:
        # 1. Authenticates with Google Sheets API using service account
        # 2. Retrieves credentials from GitHub secret (GOOGLE_CREDENTIALS)
        # 3. Appends test result row to the Google Sheet
        # 4. Logs: timestamp, branch, test status, GitHub run ID
        # ==================================================================
        
        import json
        import os
        from google.oauth2.service_account import Credentials
        from googleapiclient.discovery import build
        from datetime import datetime
        
        # Load Google service account credentials from GitHub secret
        # GOOGLE_CREDENTIALS secret contains the JSON credentials file content
        credentials_json = os.getenv('GOOGLE_CREDENTIALS')
        credentials_dict = json.loads(credentials_json)
        
        # Authenticate with Google Sheets API
        # Scopes: permissions needed to read/write sheets
        credentials = Credentials.from_service_account_info(
            credentials_dict,
            scopes=['https://www.googleapis.com/auth/spreadsheets']
        )
        
        # Build Google Sheets API client for making requests
        service = build('sheets', 'v4', credentials=credentials)
        
        # Extract test run information from GitHub Actions environment
        test_status = "${{ job.status }}"      # success or failure
        run_id = "${{ github.run_id }}"        # GitHub workflow run ID
        ref = "${{ github.ref }}"              # Branch or tag name (e.g., refs/heads/main)
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")  # Current timestamp
        
        # Prepare data row to append to Google Sheet
        # Format: [Timestamp, Branch, Status, Run ID]
        values = [[timestamp, ref, test_status, run_id]]
        
        # Build API request body with data to append
        body = {'values': values}
        
        # Append data to Google Sheet
        # spreadsheetId: ID of the Google Sheet (from GitHub secret)
        # range: Sheet1!A:D means append to columns A through D in Sheet1
        # valueInputOption: USER_ENTERED treats values as if user typed them
        result = service.spreadsheets().values().append(
            spreadsheetId=os.getenv('GOOGLE_SHEETS_ID'),
            range='Sheet1!A:D',
            valueInputOption='USER_ENTERED',
            body=body
        ).execute()
        
        # Log successful update
        print(f"âœ“ Google Sheet updated: {result.get('updates', {}).get('updatedRows', 0)} row(s) appended")
        
        PYTHON
      
      # Environment variables for this step
      # These GitHub secrets are configured in repository settings
      env:
        # GOOGLE_CREDENTIALS: JSON content of service account credentials
        # Contains: type, project_id, private_key_id, private_key, client_email, etc.
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        
        # GOOGLE_SHEETS_ID: ID of the Google Sheet to update
        # Found in the URL: https://docs.google.com/spreadsheets/d/{SHEET_ID}/edit
        GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}

# ==============================================================================
# Setup Instructions
# ==============================================================================
# Before this workflow can run, configure GitHub secrets:
#
# 1. GOOGLE_CREDENTIALS (Required)
#    - Create a Google Cloud Service Account (https://console.cloud.google.com)
#    - Download the JSON credentials file
#    - Copy entire JSON content as the secret value
#
# 2. GOOGLE_SHEETS_ID (Required)
#    - Find your Google Sheet ID from its URL:
#      https://docs.google.com/spreadsheets/d/{THIS_IS_THE_ID}/edit
#    - Add as GitHub secret
#
# 3. Share your Google Sheet
#    - Share with the service account email (from credentials JSON)
#    - Grant "Editor" permission
#
# Expected Google Sheet Format:
#    Column A: Timestamp (e.g., 2026-01-10 14:30:45)
#    Column B: Branch (e.g., refs/heads/main)
#    Column C: Status (success or failure)
#    Column D: Run ID (GitHub workflow run ID)
# ==============================================================================