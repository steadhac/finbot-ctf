{% extends "base.html" %}

{% block nav_challenges %}active{% endblock %}

{% block page_title %}Challenges{% endblock %}
{% block page_subtitle %}Test your AI security skills{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-3">
    <!-- Search -->
    <div class="relative">
        <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <input type="text" id="search-input" placeholder="Search challenges..."
               class="pl-10 pr-4 py-2 bg-portal-bg-tertiary border border-ctf-primary/20 rounded-lg text-sm text-text-primary placeholder-text-secondary focus:outline-none focus:border-ctf-primary/50 w-64">
    </div>
    <!-- Refresh -->
    <button onclick="loadChallenges()" class="vendor-btn quantum-secondary">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="flex gap-6">
    <!-- Filters Sidebar -->
    <aside class="w-64 flex-shrink-0 space-y-6">
        <!-- Status Filter -->
        <div class="holographic-card p-4">
            <h3 class="text-sm font-semibold text-text-bright mb-3">Status</h3>
            <div class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="status" value="" checked class="ctf-radio">
                    <span class="text-sm text-text-secondary group-hover:text-text-primary">All Challenges</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="status" value="available" class="ctf-radio">
                    <span class="text-sm text-text-secondary group-hover:text-text-primary">Available</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="status" value="in_progress" class="ctf-radio">
                    <span class="text-sm text-text-secondary group-hover:text-text-primary">In Progress</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="status" value="completed" class="ctf-radio">
                    <span class="text-sm text-text-secondary group-hover:text-text-primary">Completed</span>
                </label>
            </div>
        </div>

        <!-- Difficulty Filter -->
        <div class="holographic-card p-4">
            <h3 class="text-sm font-semibold text-text-bright mb-3">Difficulty</h3>
            <div class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="difficulty" value="" checked class="ctf-radio">
                    <span class="text-sm text-text-secondary group-hover:text-text-primary">All Levels</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="difficulty" value="beginner" class="ctf-radio">
                    <span class="text-sm text-green-400">Beginner</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="difficulty" value="intermediate" class="ctf-radio">
                    <span class="text-sm text-blue-400">Intermediate</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="difficulty" value="advanced" class="ctf-radio">
                    <span class="text-sm text-yellow-400">Advanced</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="difficulty" value="expert" class="ctf-radio">
                    <span class="text-sm text-red-400">Expert</span>
                </label>
            </div>
        </div>

        <!-- Category Filter -->
        <div class="holographic-card p-4">
            <h3 class="text-sm font-semibold text-text-bright mb-3">Category</h3>
            <div id="category-filters" class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="radio" name="category" value="" checked class="ctf-radio">
                    <span class="text-sm text-text-secondary group-hover:text-text-primary">All Categories</span>
                </label>
                <!-- Categories loaded dynamically -->
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="holographic-card p-4">
            <h3 class="text-sm font-semibold text-text-bright mb-3">Your Progress</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-xs text-text-secondary">Completed</span>
                    <span class="text-sm font-mono text-ctf-accent" id="filter-completed">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-text-secondary">In Progress</span>
                    <span class="text-sm font-mono text-ctf-warning" id="filter-in-progress">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-text-secondary">Available</span>
                    <span class="text-sm font-mono text-text-primary" id="filter-available">0</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1">
        <!-- Results Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="text-sm text-text-secondary">
                Showing <span id="results-count" class="text-text-primary font-medium">--</span> challenges
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-text-secondary">Sort by:</span>
                <select id="sort-select" class="bg-portal-bg-tertiary border border-ctf-primary/20 rounded-lg px-3 py-1.5 text-sm text-text-primary focus:outline-none focus:border-ctf-primary/50">
                    <option value="difficulty">Difficulty</option>
                    <option value="points">Points</option>
                    <option value="category">Category</option>
                    <option value="title">Title</option>
                </select>
            </div>
        </div>

        <!-- Challenges Grid -->
        <div id="challenges-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            <!-- Loading skeletons -->
            <div class="ctf-challenge-card p-5">
                <div class="ctf-skeleton h-6 w-3/4 mb-3"></div>
                <div class="ctf-skeleton h-4 w-full mb-2"></div>
                <div class="ctf-skeleton h-4 w-2/3 mb-4"></div>
                <div class="flex justify-between">
                    <div class="ctf-skeleton h-5 w-20"></div>
                    <div class="ctf-skeleton h-5 w-16"></div>
                </div>
            </div>
            <div class="ctf-challenge-card p-5">
                <div class="ctf-skeleton h-6 w-3/4 mb-3"></div>
                <div class="ctf-skeleton h-4 w-full mb-2"></div>
                <div class="ctf-skeleton h-4 w-2/3 mb-4"></div>
                <div class="flex justify-between">
                    <div class="ctf-skeleton h-5 w-20"></div>
                    <div class="ctf-skeleton h-5 w-16"></div>
                </div>
            </div>
            <div class="ctf-challenge-card p-5">
                <div class="ctf-skeleton h-6 w-3/4 mb-3"></div>
                <div class="ctf-skeleton h-4 w-full mb-2"></div>
                <div class="ctf-skeleton h-4 w-2/3 mb-4"></div>
                <div class="flex justify-between">
                    <div class="ctf-skeleton h-5 w-20"></div>
                    <div class="ctf-skeleton h-5 w-16"></div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
            <div class="text-4xl mb-4">üîç</div>
            <h3 class="text-lg font-semibold text-text-bright mb-2">No challenges found</h3>
            <p class="text-text-secondary text-sm">Try adjusting your filters or search query.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .ctf-radio {
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 50%;
        background: transparent;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .ctf-radio:checked {
        border-color: var(--vendor-primary);
        background: radial-gradient(circle, var(--vendor-primary) 40%, transparent 50%);
        box-shadow: 0 0 8px rgba(0, 212, 255, 0.4);
    }

    .ctf-radio:hover {
        border-color: var(--vendor-primary);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let allChallenges = [];
let categories = new Set();

document.addEventListener('DOMContentLoaded', function() {
    loadChallenges();
    setupFilters();
});

async function loadChallenges() {
    try {
        allChallenges = await CTF.getChallenges();

        // Extract categories
        categories = new Set(allChallenges.map(c => c.category));
        updateCategoryFilters();

        // Update stats
        updateFilterStats();

        // Render
        applyFiltersAndRender();

    } catch (error) {
        console.error('Failed to load challenges:', error);
        showToast('Failed to load challenges', 'error');
    }
}

function setupFilters() {
    // Status filter
    document.querySelectorAll('input[name="status"]').forEach(radio => {
        radio.addEventListener('change', applyFiltersAndRender);
    });

    // Difficulty filter
    document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
        radio.addEventListener('change', applyFiltersAndRender);
    });

    // Category filter (delegated)
    document.getElementById('category-filters').addEventListener('change', applyFiltersAndRender);

    // Sort
    document.getElementById('sort-select').addEventListener('change', applyFiltersAndRender);

    // Search with debounce
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFiltersAndRender, 300);
    });
}

function updateCategoryFilters() {
    const container = document.getElementById('category-filters');
    const existingAll = container.querySelector('input[value=""]').parentElement;

    // Clear and re-add "All"
    container.innerHTML = '';
    container.appendChild(existingAll);

    // Add categories
    Array.from(categories).sort().forEach(cat => {
        const label = document.createElement('label');
        label.className = 'flex items-center gap-2 cursor-pointer group';
        label.innerHTML = `
            <input type="radio" name="category" value="${cat}" class="ctf-radio">
            <span class="text-sm text-text-secondary group-hover:text-text-primary">${formatCategoryName(cat)}</span>
        `;
        container.appendChild(label);
    });
}

function updateFilterStats() {
    const completed = allChallenges.filter(c => c.status === 'completed').length;
    const inProgress = allChallenges.filter(c => c.status === 'in_progress').length;
    const available = allChallenges.filter(c => c.status === 'available').length;

    document.getElementById('filter-completed').textContent = completed;
    document.getElementById('filter-in-progress').textContent = inProgress;
    document.getElementById('filter-available').textContent = available;
}

function applyFiltersAndRender() {
    const status = document.querySelector('input[name="status"]:checked')?.value || '';
    const difficulty = document.querySelector('input[name="difficulty"]:checked')?.value || '';
    const category = document.querySelector('input[name="category"]:checked')?.value || '';
    const search = document.getElementById('search-input').value.toLowerCase().trim();
    const sortBy = document.getElementById('sort-select').value;

    // Filter
    let filtered = allChallenges.filter(c => {
        if (status && c.status !== status) return false;
        if (difficulty && c.difficulty !== difficulty) return false;
        if (category && c.category !== category) return false;
        if (search && !c.title.toLowerCase().includes(search) && !c.category.toLowerCase().includes(search)) return false;
        return true;
    });

    // Sort
    filtered.sort((a, b) => {
        switch (sortBy) {
            case 'points':
                return b.points - a.points;
            case 'category':
                return a.category.localeCompare(b.category);
            case 'title':
                return a.title.localeCompare(b.title);
            case 'difficulty':
            default:
                const order = { 'beginner': 0, 'intermediate': 1, 'advanced': 2, 'expert': 3 };
                return (order[a.difficulty] || 0) - (order[b.difficulty] || 0);
        }
    });

    renderChallenges(filtered);
}

function renderChallenges(challenges) {
    const grid = document.getElementById('challenges-grid');
    const empty = document.getElementById('empty-state');
    const countEl = document.getElementById('results-count');

    countEl.textContent = challenges.length;

    if (challenges.length === 0) {
        grid.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
    }

    grid.classList.remove('hidden');
    empty.classList.add('hidden');

    grid.innerHTML = challenges.map(ch => `
        <a href="/ctf/challenges/${ch.id}" class="ctf-challenge-card relative p-5 block group ${ch.status === 'completed' ? 'completed' : ''}">
            <!-- Status indicator -->
            ${ch.status === 'completed' ? `
                <div class="absolute top-3 right-3 w-6 h-6 rounded-full bg-gradient-to-br from-ctf-accent to-ctf-primary flex items-center justify-center">
                    <svg class="w-3 h-3 text-portal-bg-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
            ` : ch.status === 'in_progress' ? `
                <div class="absolute top-3 right-3 w-6 h-6 rounded-full bg-gradient-to-br from-ctf-warning to-orange-500 flex items-center justify-center">
                    <svg class="w-3 h-3 text-portal-bg-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            ` : ''}

            <!-- Category tag -->
            <div class="text-xs text-ctf-secondary font-mono mb-2">${formatCategoryName(ch.category)}</div>

            <!-- Title -->
            <h3 class="text-text-bright font-semibold mb-2 group-hover:text-ctf-primary transition-colors">${ch.title}</h3>

            <!-- Subcategory if exists -->
            ${ch.subcategory ? `<div class="text-xs text-text-secondary mb-3">${ch.subcategory}</div>` : '<div class="mb-3"></div>'}

            <!-- Footer -->
            <div class="flex justify-between items-center mt-auto pt-3 border-t border-white/5">
                <span class="${getDifficultyClass(ch.difficulty)}">${ch.difficulty}</span>
                <span class="ctf-points">‚ö° ${ch.points}</span>
            </div>
        </a>
    `).join('');
}

function formatCategoryName(category) {
    return category
        .replace(/[-_]/g, ' ')
        .replace(/\b\w/g, c => c.toUpperCase());
}
</script>
{% endblock %}
